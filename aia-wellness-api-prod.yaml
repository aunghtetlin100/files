apiVersion: apps/v1
kind: Deployment
metadata:
  name: wellness-api
  namespace: nsp-mm-p-member 
spec:
  selector:
      matchLabels:
        app-name: wellness-api-pod
  replicas: 1
  template:
    metadata:
      labels:
        app-name: wellness-api-pod
    spec:
      containers:
        - name: wellness-api
          image: acrmm01seanshared01.azurecr.io/mm/wellness/api/wellness:20210604
          ports:
            - containerPort: 8081
          volumeMounts:
            - name: secrets-store-inline
              mountPath: "/mnt/secrets-store"
              readOnly: true
          env:
          - name: api.root.url
            value: https://wellness.aia.com.mm/api/
          - name: db_server
            value: mmazepsdb0001.database.windows.net
          - name: db_name
            value: WELMBADATPSDB01
          - name: stsurl
            value: https://login.microsoftonline.com/7f2c1900-9fd4-4b89-91d3-79a649996f0a
          - name: clientSecret
            valueFrom:
              secretKeyRef:
                name: appvlt01
                key: sp_dbwellness_secret
          - name: clientId
            valueFrom:
              secretKeyRef:
                name: appvlt01
                key: sp_dbwellness_id
      volumes:
        - name: secret-volume
          secret:
            secretName: tls-aia-internal-ca
        - name: secrets-store-inline
          csi:
            driver: secrets-store.csi.k8s.io
            readOnly: true
            volumeAttributes:
              secretProviderClass: "spc-mm-p-member"
            nodePublishSecretRef:
              name: "kvsecretcreds"
---
apiVersion: v1
kind: Service
metadata:
  name: wellness-api-service
  namespace: nsp-mm-p-member
spec:
    type: ClusterIP
    ports:
    - port: 8081
    selector:
      app-name: wellness-api-pod
---
apiVersion: networking.k8s.io/v1beta1
kind: Ingress
metadata:
	name: wellness-api-ingress
	namespace: nsp-mm-p-member
	annotations:
		kubernetes.io/ingress.class: nginx
		nginx.ingress.kubernetes.io/ssl-redirect: "false"
    nginx.ingress.kubernetes.io/use-regex: "true"
    nginx.ingress.kubernetes.io/rewrite-target: /api/$2
    nginx.ingress.kubernetes.io/proxy-body-size: 10m
	spec:
    tls:
    - hosts:
      - wellness.aia.com.mm
      secretName: ingress-nginx-tls-u-mmwellnessingress
		rules:
    - host: wellness.aia.com.mm
    - http:
        paths:
        -backend:
					  serviceName: wellness-api-service
					  servicePort: 8081
				  path: /api(/|$)(.*)